ARG PYTHON_VERSION=3.13
FROM python:${PYTHON_VERSION}-slim AS base

WORKDIR /app

# Install Poetry
RUN pip install --no-cache-dir poetry

# Copy only dependency files to cache dependencies
COPY pyproject.toml poetry.lock* ./

# Configure Poetry to not create a virtual environment
RUN poetry config virtualenvs.create false

# Install dependencies
RUN poetry install --no-interaction --no-ansi

# Copy the rest of the application
COPY . .

# Stage for running tests with coverage
FROM base AS test

ARG COVERAGE_THRESHOLD=100

# Run tests with coverage and export the results
RUN mkdir -p /app/coverage && \
    poetry run pytest --cov=app --cov-report=html:/app/coverage/htmlcov \
    --cov-report=term-missing --cov-fail-under=${COVERAGE_THRESHOLD} \
    --cov-config=.coveragerc && \
    cp .coverage /app/coverage/

# Save coverage report
ENTRYPOINT ["tail", "-f", "/dev/null"]